module ArticlesHelper
  include ActionView::Helpers::SanitizeHelper

  def author_label(article)
    author = article.author
    handle = author.nil? ? "Anonymous" : author.handle
    content_tag :label, "by #{handle}", class: "ui label"
  end

  def parse_katex(html, strip_tags: true, escape_html: false)
    return nil if html.blank?
    compile_katex(html, strip_tags, escape_html).html_safe
  end

  private
  def compile_katex(html, strip_tags, escape_html)
    tokens = html.split('$$')
    return strip_and_compile(tokens) if strip_tags
    escape_html ?  : sanitize_and_compile(tokens)
  end

  def sanitize_and_compile(tokens)
    tokens.each_with_index do |text, i|
      tokens[i] = Katex.render(text) if i.odd?
    end
    tokens.join('')
  end

  def strip_and_compile(tokens)
    tokens.each_with_index do |text, i|
      tokens[i] = i.odd? ? Katex.render(text) : strip_tags(text)
    end
    tokens.join('')
  end
end
